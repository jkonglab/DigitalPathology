<div class="bmd-layout-container bmd-drawer-f-l bmd-drawer-in">
	<div id="dw-1" class="bmd-layout-drawer bg-faded" aria-expanded="false" aria-hidden="false">
		<div class="drawer-tab active drawer-home">
			<%= render partial: "drawer_home", locals: { image: @image } %>
		</div>
		<div class="drawer-tab drawer-annotations">
			<%= render partial: "drawer_annotations", locals: { annotation: @annotation, image: @image } %>
		</div>
		<div class="drawer-tab drawer-data">
			<%= render partial: "drawer_data", locals: { image_json: @image_json, image: @image } %>
		</div>
    </div>

    <div class="bmd-layout-content">
		<div class="row">
			<div class="col-12">
				<div id="<%=@image.upload_file_name.parameterize%>" class="openseadragon">
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	var viewer = OpenSeadragon({
	    id:            "<%=@image.upload_file_name.parameterize%>",
	    prefixUrl:     "/openseadragon/images/",
	    tileSources:   "/<%=Rails.application.config.data_directory%>/<%=@image.file_name_prefix%>/<%=@image.file_name_prefix%>.dzi",
	});

	viewer.initializeAnnotations();
	bindAnnotationRows();

	$('.drawer-link').click(function(){
		var clicked_tab = $(this).attr('data-tab');
		$('.drawer-tab').removeClass('active');
		$('.'+clicked_tab).css('opacity',0).addClass('active').animate({opacity: 1}, 50);

		if(clicked_tab == 'drawer-annotations'){
			$( ".openseadragon-canvas svg" ).mouseup(function() {
				promptAndSaveAnnotation();
			});
		}else{
			viewer.stopDrawing();
		}
	});

	$('.start-draw').click(function(){
		viewer.startDrawing(); 
		$('.start-draw').hide(); 
		$('.stop-draw').show();
	});

	$('.stop-draw').click(function(){
		viewer.stopDrawing(); 
		$('.start-draw').show(); 
		$('.stop-draw').hide();
	});

	function bindAnnotationRows(){
		$('.annotation-row').unbind().click(function(){
			var annotation_data = JSON.parse($(this).attr('annotation-data'))[0];
			var existing_annotations = viewer.annotations.get();
			existing_annotations.push(annotation_data);
			viewer.annotations.set(existing_annotations);
		});
	}

	function promptAndSaveAnnotation(){
		var annotation_label = prompt("Please label your annotation", "");
	    if (annotation_label != null) {
	    	all_annotations = viewer.annotations.get();
	    	all_annotations[all_annotations.length-1][1]["d"] = all_annotations[all_annotations.length-1][1]["d"] + 'Z';
	    	viewer.annotations.set(all_annotations);
	        $.post( '<%= annotations_path %>.json', {
			  	'image_id': <%= @image.id %>,
			  	'label': annotation_label,
			  	'data': JSON.stringify([all_annotations[all_annotations.length-1]])
			})
	        .done(function(data){
	        	$( ".annotations-table" ).prepend("<tr class='annotation-row' annotation-data='" + JSON.stringify(data.data) + "'><td>" + data.label + "</td><td>" + data.created_at + "</td></tr>" );
	        	bindAnnotationRows();
	        });
	    }else{
	    	viewer.annotations.clean();
	    }
	}

</script>

<div id="general-modal" class="modal fade" role="dialog">
	<div class="modal-dialog" style="margin-top:100px;">
   		<div class="modal-content">
     		<div class="modal-header">
       			<button type="button" class="close" data-dismiss="modal">&times;</button>
      			<h4 id="general-modal-title" class="modal-title"></h4>
     		</div>
    		<div class="modal-body">
				<div class="md-form" style="margin-right: 0">
					<input type="hidden" id="quick_input_field_key" class="form-control">
		   			<input type="text" id="quick_input_field" class="form-control">
				</div>
    		</div>
    		<div class="modal-footer">
		       	<button onclick="submitData()" class="btn btn-primary">Submit</button>
		    </div>
    	</div>
    </div>
</div>

<div id="run-modal" class="modal fade" role="dialog">
	<div class="modal-dialog"  style="margin-top:200px;">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
      			<h4 id="general-modal-title" class="modal-title">Run Analysis on ROI</h4>
			</div>
			<div class="modal-body">
				<%= render partial: "runs/form" %>
			</div>
			<div class="modal-footer">
			</div>
		</div>
	</div>
</div>


